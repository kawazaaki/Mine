<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فاکتور فروش</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            position: relative;
            top: 40px;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        input {
            width: 100%;
            text-align: center;
            border: none;
            background: transparent;
        }
        select {
            position: absolute;
            top: 80px;
        }
        #addBtn {
            position: absolute;
            top: 76px;
            right: 140px;
            transition: 100ms;
            border-radius: 10px;
            cursor: pointer;
        }
        #addBtn:active {
            background-color: rgba(0, 0, 0, 0.295);
        }
        #t {
            font-size: 10px;
            color: rgba(0, 0, 0, 0.623);
        }
        .delete-btn {
            cursor: pointer;
            color: red;
        }
        .description-cell {
            position: relative;
        }
        #downloadBtn {
            position: absolute;
            top: 76px;
            right: 190px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .action-buttons {
            position: absolute;
            top: 50px;
            right: 200px;
        }
        .toggle-wrapper{
            position: absolute;
            top: 20px;
            left: 60px;
        }
        #type{
            position: absolute;
            top: 20px;
            left: 0px;
        }
        #date{
            position: absolute;
            top: 40px;
        }
        #dateInput{
            border:1px solid #ccc;
            padding: 1px; 
            border-radius:5px;
            text-align: center;
            width: 100px;
        }
        #ceck{
            position: absolute;
        }
    </style>
</head>
<body dir="rtl">
    <button id="downloadBtn">دانلود فاکتور</button>
    <img src="add_24dp_434343.svg" alt="" id="addBtn">
    <select name="" id="itemSelect">

    <option value="" disabled selected>اضافه کردن</option>
    <option>دستمزد لوله ¼1</option>
    <option>دستمزد لوله ½1</option>
    <option>دستمزد لوله 2</option>
    <option>لوله ½1</option>
    <option>لوله 2</option>
    <option>نقشه G6</option>
    <option>نقشه G6 دو واحده</option>
    <option>نقشه G10</option>
    <option>نقشه G10 سه واحده</option>
    <option>نقشه G25</option>
    <option>نقشه G40</option>
    <option>نقشه G65</option>
    <option>مراجعات ناظر روستایی</option>
    <option>گردش پرونده روستایی</option>
    <option>برشکاری ½1</option>
    <option>برشکاری 2</option>
    <option>برشکاری ½2</option>
    <option>برشکاری 3</option>
    <option>برشکاری 4</option>
    <option>لوله کشی گاز تجاری زیر 20 متر</option>

    
</select>
<div id="date">
    <label for="dateInput">تاریخ فاکتور: </label>
<input type="text" id="dateInput" >
</div>
    <h5>جمع کل: <span id="totalSum">0</span> تومان</h5>
 


<h5 id="type">توکار</h5>

<table id="myTable">
    <thead>
        <tr>
            <th>شرح</th>
            <th>قیمت واحد</th>
            <th>تعداد</th>
            <th>جمع <span id="t">(تومان)</span></th>
        </tr>
    </thead>
    <tbody>
        <tr>
           <td class="description-cell">لوله &#188;1 </td>
            <td><input type="text" class="price-input" data-value="0"></td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">لوله 1 </td>
            <td><input type="text" class="price-input" data-value="0"></td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">لوله &#190;</td>
            <td><input type="text" class="price-input" data-value="0"></td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">لوله &#189;</td>
            <td><input type="text" class="price-input" data-value="0"></td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
           <td class="description-cell">اتصالات &#188;1</td>
            <td>58,000</td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">اتصالات 1</td>
            <td>56,000</td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">شیر آذر سنگین &#188;1</td>
            <td><input type="text" class="price-input" data-value="0"></td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell"> شیر آذر سنگین 1</td>
            <td><input type="text" class="price-input" data-value="0"></td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
           <td class="description-cell"> شیر آذر سنگین &#190;</td>
            <td><input type="text" class="price-input" data-value="0"></td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">شیر آذر سنگین &#189;</td>
            <td><input type="text" class="price-input" data-value="0"></td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">قفل شونده آذر</td>
            <td><input type="text" class="price-input" data-value="0"></td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">رابط کامل</td>
            <td><input type="text" class="price-input" data-value="0"></td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
           <td class="description-cell">تفلون</td>
            <td><input type="text" class="price-input" data-value="0"></td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">پرایمر</td>
            <td><input type="text" class="price-input" data-value="0"></td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">رنگ</td>
            <td>17,000</td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">نقشه G4</td>
            <td>2,100,000</td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">خدمات ثبت</td>
            <td>145,000</td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">گردش پرونده شهری</td>
            <td>420,000</td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">مراجعات ناظر شهری</td>
            <td>145,000</td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">برشکاری &#188;1</td>
            <td>520,000</td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">برشکاری 1</td>
            <td>390,000</td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">جا به جایی کنتور</td>
            <td>520,000</td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">نصب کنتور موجود</td>
            <td>500,000</td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">نصب رگولاتور موجود</td>
            <td>500,000</td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        
        <tr>
            <td class="description-cell">ایجاد کلکتور</td>
            <td>260,000</td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">شیر فرعی در مسیر</td>
            <td>260,000</td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">دستمزد لوله 1</td>
            <td>140,000</td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">پایین آوردن سیستم <br> برای هر واحد</td>
            <td>750,000</td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
        <tr>
            <td class="description-cell">حمل وسایل</td>
            <td><input type="text" class="price-input" data-value="0"></td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        </tr>
    </tbody>
</table>
<!-- CDN تبدیل تاریخ میلادی به شمسی -->
<script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
// جداکننده هزارگان
function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// تبدیل عدد فرمت‌شده به عدد خالص
function parseFormattedNumber(str) {
    return parseFloat(str.replace(/,/g, '')) || 0;
}

// هندل ورود قیمت
function handlePriceInput(input) {
    const cursorPosition = input.selectionStart;
    let value = input.value;
    let numericValue = value.replace(/[^0-9]/g, '');
    let number = parseFloat(numericValue) || 0;
    input.setAttribute('data-value', number);
    input.value = formatNumber(number);
    let newCursorPosition = cursorPosition;
    const diff = input.value.length - value.length;
    if (diff > 0) {
        newCursorPosition += diff;
    }
    input.setSelectionRange(newCursorPosition, newCursorPosition);
    calculateRowSum(input.closest('tr'));
}

// محاسبه مجموع هر ردیف
function calculateRowSum(row) {
    const price = parseFloat(row.querySelector('.price-input').getAttribute('data-value')) || 0;
    const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
    const sum = price * quantity;
    row.querySelector('.sum-cell').textContent = formatNumber(sum);
    calculateTotalSum();
}

// جمع کل
function calculateTotalSum() {
    const sumCells = document.querySelectorAll('.sum-cell');
    let total = 0;
    sumCells.forEach(cell => {
        const value = parseFormattedNumber(cell.textContent) || 0;
        total += value;
    });
    document.getElementById('totalSum').textContent = formatNumber(total);
}

// حذف ردیف
function removeRow(row, productName) {
    row.remove();
    const select = document.getElementById('itemSelect');
    const newOption = document.createElement('option');
    newOption.textContent = productName;
    select.appendChild(newOption);
    calculateTotalSum();
}

// اضافه کردن ردیف جدید
document.getElementById('addBtn').addEventListener('click', function () {
    const select = document.getElementById('itemSelect');
    const selectedItem = select.value;

    if (selectedItem && selectedItem !== "اضافه کردن") {
        const table = document.querySelector('#myTable tbody');
        const newRow = table.insertRow(-1);

        newRow.innerHTML = `
            <td class="description-cell">${selectedItem} <span class="delete-btn">❌</span></td>
            <td><input type="text" class="price-input" data-value="0"></td>
            <td><input type="number" class="quantity-input"></td>
            <td class="sum-cell">0</td>
        `;

        newRow.querySelector('.price-input').addEventListener('input', function () {
            handlePriceInput(this);
        });

        newRow.querySelector('.quantity-input').addEventListener('input', function () {
            calculateRowSum(this.closest('tr'));
        });

        newRow.querySelector('.delete-btn').addEventListener('click', function () {
            removeRow(newRow, selectedItem);
        });

        // حذف از لیست
        const optionToRemove = Array.from(select.options).find(option => option.value === selectedItem || option.text === selectedItem);
        if (optionToRemove) {
            select.removeChild(optionToRemove);
        }

        select.value = "";
    }
});

// دکمه دانلود فاکتور
document.getElementById('downloadBtn').addEventListener('click', function () {
    const rows = document.querySelectorAll('#myTable tbody tr');
    const totalSum = document.getElementById('totalSum').textContent;
    const dateValue = document.getElementById('dateInput').value;

    let anyError = false;

    rows.forEach(row => {
        const priceInput = row.querySelector('.price-input');
        const quantityInput = row.querySelector('.quantity-input');

        const price = parseFloat(priceInput.getAttribute('data-value')) || 0;
        const quantity = parseFloat(quantityInput.value) || 0;

        priceInput.style.backgroundColor = '';
        quantityInput.style.backgroundColor = '';

        if ((price > 0 && quantity === 0) || (price === 0 && quantity > 0)) {
            anyError = true;
            if (price === 0) priceInput.style.backgroundColor = 'rgba(255,0,0,0.3)';
            if (quantity === 0) quantityInput.style.backgroundColor = 'rgba(255,0,0,0.3)';
        }
    });

    if (anyError) {
        alert("لطفاً فیلدهای ناقص را کامل کنید.");
        return;
    }

    const table = document.querySelector("#myTable");
    const clonedTable = table.cloneNode(true);
    const tbody = clonedTable.querySelector('tbody');

    // حذف ردیف‌های خالی
    Array.from(tbody.rows).forEach(row => {
        const price = parseFloat(row.querySelector('.price-input')?.getAttribute('data-value')) || 0;
        const quantity = parseFloat(row.querySelector('.quantity-input')?.value) || 0;
        if (price === 0 && quantity === 0) {
            row.remove();
        }
    });

    // حذف inputها و تبدیل‌شون به span
    tbody.querySelectorAll('input').forEach(input => {
        const td = input.parentElement;
        const span = document.createElement('span');
        span.textContent = input.value || '0';
        td.textContent = '';
        td.appendChild(span);
    });

    // حذف دکمه‌های حذف
    clonedTable.querySelectorAll('.delete-btn').forEach(btn => btn.remove());

    // اضافه کردن جمع کل
    const finalRow = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 4;
    td.style.textAlign = "center";
    td.style.fontWeight = "bold";
    td.textContent = "جمع کل: " + totalSum + " تومان";
    finalRow.appendChild(td);
    tbody.appendChild(finalRow);

    // اضافه کردن تاریخ بالای جدول
    const caption = document.createElement('caption');
    caption.textContent = 'تاریخ فاکتور: ' + dateValue;
    caption.style.textAlign = 'right';
    caption.style.fontWeight = 'bold';
    caption.style.marginBottom = '10px';
    clonedTable.insertBefore(caption, clonedTable.firstChild);

    // افزودن موقت برای عکس
    clonedTable.style.position = 'absolute';
    clonedTable.style.top = '-9999px';
    document.body.appendChild(clonedTable);

    html2canvas(clonedTable).then(canvas => {
        const link = document.createElement('a');
        link.download = 'فاکتور.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        clonedTable.remove();
    });
});

// مقداردهی تاریخ شمسی پیش‌فرض
window.addEventListener('DOMContentLoaded', () => {
    const today = new Date();
    const jDate = window.jalaali.toJalaali(today.getFullYear(), today.getMonth() + 1, today.getDate());
    const formatted = `${jDate.jy}/${String(jDate.jm).padStart(2, '0')}/${String(jDate.jd).padStart(2, '0')}`;
    document.getElementById('dateInput').value = formatted;
});

// فعال‌سازی ورودی‌ها در جدول اولیه
document.querySelectorAll('.price-input').forEach(input => {
    input.addEventListener('input', function () {
        handlePriceInput(this);
    });
});

document.querySelectorAll('.quantity-input').forEach(input => {
    input.addEventListener('input', function () {
        calculateRowSum(this.closest('tr'));
    });
});
function setupKeyboardNavigation() {
    const allInputs = document.querySelectorAll('.quantity-input, .price-input');
    allInputs.forEach((input, i) => {
        input.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();

                // لیست همه ورودی‌ها به ترتیب ظاهر در DOM
                const inputs = Array.from(document.querySelectorAll('.quantity-input, .price-input'));
                const index = inputs.indexOf(this);

                if (index > -1 && index + 1 < inputs.length) {
                    inputs[index + 1].focus();
                }
            }
        });
    });
}

// بار اول که صفحه لود میشه
window.addEventListener('DOMContentLoaded', () => {
    const today = new Date();
    const jDate = window.jalaali.toJalaali(today.getFullYear(), today.getMonth() + 1, today.getDate());
    const formatted = `${jDate.jy}/${String(jDate.jm).padStart(2, '0')}/${String(jDate.jd).padStart(2, '0')}`;
    document.getElementById('dateInput').value = formatted;

    setupKeyboardNavigation(); // 👈 اینجا صداش بزن
});

</script>


</body>
</html>
